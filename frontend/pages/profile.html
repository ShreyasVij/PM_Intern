<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | PM Intern</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .profile-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-form {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .skills-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            min-height: 2rem;
        }

        .skill-tag {
            background: var(--bg-tertiary);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .skill-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
            opacity: 0.6;
            transition: all 0.2s ease;
            color: var(--text-muted);
            margin-left: 0.25rem;
        }

        .skill-tag .remove:hover {
            opacity: 1;
            color: var(--error);
        }

        .skill-tag:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .add-skill {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .add-skill input {
            flex: 1;
        }

        .add-skill button {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .add-skill button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .btn-edit {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-edit:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--topbar-bg);
            backdrop-filter: blur(20px);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            min-height: 60px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
        }

        .back-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .navigation h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            text-align: center;
            flex: 1;
        }

        .status-message {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        /* Recommendation styles removed - recommendations are now shown on the main index.html page */

        .hidden {
            display: none;
        }

        .profile-display {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .profile-display h3 {
            margin-bottom: 1.5rem;
            color: var(--text);
            text-align: center;
        }

        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .info-item label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .info-item .value {
            color: var(--text);
            font-size: 1rem;
        }

        .skills-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .skill-display {
            background: var(--bg-tertiary);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .edit-toggle {
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .theme-toggle {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            stroke: var(--text);
        }

        /* Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
            width: 100%;
        }
        /* Ensure skills dropdown shares row with button without overlaying it */
        .add-skill .searchable-dropdown {
            flex: 1 1 auto;
            width: auto;
            min-width: 0;
        }

        .searchable-dropdown input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-right: 2.5rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .searchable-dropdown input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .dropdown-arrow {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .searchable-dropdown.open .dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .searchable-dropdown.open .dropdown-options {
            display: block;
        }

        .dropdown-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: var(--primary-light);
        }

        .dropdown-option.selected {
            background: var(--primary);
            color: white;
        }

        .dropdown-option.highlighted {
            background: var(--primary-light);
        }

        .no-results {
            padding: 0.75rem 1rem;
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" aria-label="Toggle theme">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
        </svg>
    </button>

    <div class="profile-container">
        <div class="navigation">
            <a href="index.html" class="back-btn">
                ← Back to Home
            </a>
            <h1>Profile Management</h1>
            <div style="width: 120px;"></div>
        </div>

        <div id="statusMessage" class="hidden"></div>

        <!-- Profile Display Section -->
        <div id="profileDisplay" class="profile-display hidden">
            <h3>Your Profile</h3>
            <div class="profile-info" id="profileInfo">
                <!-- Profile info will be populated here -->
            </div>
            <div class="edit-toggle">
                <button onclick="toggleEdit()" class="btn btn-edit" id="editToggleBtn">
                    Edit Profile
                </button>
            </div>
        </div>

        <!-- Profile Form Section -->
        <div id="profileFormSection" class="profile-form">
            <form id="profileForm">
                <div class="form-group">
                    <label for="name">Full Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="education_level">Education Level *</label>
                    <select id="education_level" name="education_level" required>
                        <option value="">Select Education Level</option>
                        <option value="Undergraduate">Undergraduate (UG)</option>
                        <option value="Postgraduate">Postgraduate (PG)</option>
                        <option value="Diploma">Diploma</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="field_of_study">Field of Study</label>
                    <input type="text" id="field_of_study" name="field_of_study" placeholder="e.g., Computer Science, Business Administration">
                </div>

                <div class="form-group">
                    <label for="location_preference">Preferred Location (City) *</label>
                    <div class="searchable-dropdown">
                        <input type="text" id="location_preference" name="location_preference" placeholder="Type to search cities..." required autocomplete="off">
                        <div class="dropdown-arrow">▼</div>
                        <div class="dropdown-options" id="cityDropdown">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Skills *</label>
                    <div class="skills-input" id="skillsContainer">
                        <!-- Skills will be added here dynamically -->
                    </div>
                    <div class="add-skill">
                        <div class="searchable-dropdown" id="skillsDropdownWrapper">
                            <input type="text" id="skillInput" placeholder="Type to search skills..." autocomplete="off">
                            <div class="dropdown-arrow">▼</div>
                            <div class="dropdown-options" id="skillsDropdown"></div>
                        </div>
                        <button type="button" id="addSkillBtn">Add Skill</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="sector_interests">Sector Interests</label>
                    <textarea id="sector_interests" name="sector_interests" rows="3" placeholder="e.g., Technology, Finance, Healthcare, Marketing"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Profile</button>
                </div>
            </form>
        </div>

        <!-- Recommendations removed - they will be shown on the main index.html page -->
    </div>

    <script>
    const API_BASE = `${window.location.origin}/api`;
        let skills = [];
    let currentProfile = null;
        let isEditMode = false;
    // Skill suggestions derived from internships
    let allSkillSuggestions = []; // original case for display
    let allSkillSuggestionsLower = new Set(); // for fast filtering and duplicates

        // Top 80+ Indian cities (alphabetically sorted)
        const cities = [
            "Agra", "Ahmedabad", "Ajmer", "Akola", "Aligarh", "Allahabad", "Amravati", "Amritsar",
            "Aurangabad", "Bangalore", "Bareilly", "Belgaum", "Bhavnagar", "Bhilai", "Bhiwandi", "Bhopal",
            "Bhubaneswar", "Bikaner", "Bokaro", "Chandigarh", "Chennai", "Coimbatore", "Cuttack", "Delhi",
            "Dhanbad", "Durg", "Faridabad", "Ghaziabad", "Guntur", "Gurgaon", "Guwahati", "Gwalior",
            "Howrah", "Hubli", "Hyderabad", "Indore", "Jabalpur", "Jaipur", "Jalandhar", "Jammu",
            "Jamshedpur", "Jhansi", "Jodhpur", "Kanpur", "Kochi", "Kolhapur", "Kolkata", "Kota",
            "Lucknow", "Ludhiana", "Madurai", "Mangalore", "Meerut", "Mysore", "Nagpur", "Nashik",
            "Navi Mumbai", "Noida", "Patna", "Pimpri-Chinchwad", "Pune", "Raipur", "Rajkot", "Ranchi",
            "Salem", "Srinagar", "Surat", "Thane", "Tiruchirappalli", "Udaipur", "Ujjain", "Vadodara",
            "Varanasi", "Vasai-Virar", "Vijayawada", "Visakhapatnam", "Warangal"
        ].sort(); // Sort alphabetically

        // DOM elements
        const profileForm = document.getElementById('profileForm');
        const skillsContainer = document.getElementById('skillsContainer');
        const skillInput = document.getElementById('skillInput');
        const addSkillBtn = document.getElementById('addSkillBtn');
        const statusMessage = document.getElementById('statusMessage');
        // Recommendations removed - they will be shown on the main index.html page
        const profileDisplay = document.getElementById('profileDisplay');
        const profileFormSection = document.getElementById('profileFormSection');
        const profileInfo = document.getElementById('profileInfo');
        const editToggleBtn = document.getElementById('editToggleBtn');
        
    // City dropdown elements
        const cityInput = document.getElementById('location_preference');
        const cityDropdown = document.getElementById('cityDropdown');
        const searchableDropdown = document.querySelector('.searchable-dropdown');

    // Skills dropdown elements
    const skillsDropdownWrapper = document.getElementById('skillsDropdownWrapper');
    const skillsDropdown = document.getElementById('skillsDropdown');
    let filteredSkills = [];
    let selectedSkillIndex = -1;

        // Theme toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.querySelector('.theme-toggle');
            const htmlElement = document.documentElement;

            function toggleTheme() {
                const currentTheme = htmlElement.getAttribute('data-theme');
                if (currentTheme === 'dark') {
                    htmlElement.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                    updateThemeIcon('light');
                } else {
                    htmlElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    updateThemeIcon('dark');
                }
            }

            function updateThemeIcon(theme) {
                if (!themeToggle) return;
                const svg = themeToggle.querySelector('svg');
                if (!svg) return;
                if (theme === 'dark') {
                    svg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>`;
                } else {
                    svg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>`;
                }
            }

            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                htmlElement.setAttribute('data-theme', 'dark');
                updateThemeIcon('dark');
            } else {
                htmlElement.removeAttribute('data-theme');
                updateThemeIcon('light');
            }
        });

        // City dropdown functionality
        function initializeCityDropdown() {
            let filteredCities = [...cities];
            let selectedIndex = -1;

            function renderOptions() {
                cityDropdown.innerHTML = '';
                
                if (filteredCities.length === 0) {
                    cityDropdown.innerHTML = '<div class="no-results">No cities found</div>';
                    return;
                }

                filteredCities.forEach((city, index) => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = city;
                    option.dataset.value = city;
                    
                    if (index === selectedIndex) {
                        option.classList.add('highlighted');
                        option.scrollIntoView({ block: 'nearest' });
                    }
                    
                    option.addEventListener('click', () => {
                        selectCity(city);
                    });
                    
                    cityDropdown.appendChild(option);
                });
            }

            function selectCity(city) {
                cityInput.value = city;
                cityInput.setAttribute('data-value', city);
                searchableDropdown.classList.remove('open');
                selectedIndex = -1;
            }

            function filterCities(query) {
                if (!query.trim()) {
                    filteredCities = [...cities];
                } else {
                    const lowerQuery = query.toLowerCase();
                    filteredCities = cities.filter(city => 
                        city.toLowerCase().includes(lowerQuery)
                    );
                }
                selectedIndex = -1;
                renderOptions();
            }

            function openDropdown() {
                searchableDropdown.classList.add('open');
                renderOptions();
            }

            function closeDropdown() {
                searchableDropdown.classList.remove('open');
                selectedIndex = -1;
            }

            // Event listeners
            cityInput.addEventListener('input', (e) => {
                const query = e.target.value;
                filterCities(query);
                openDropdown();
            });

            cityInput.addEventListener('focus', () => {
                openDropdown();
            });

            cityInput.addEventListener('blur', (e) => {
                // Delay closing to allow option clicks
                setTimeout(() => {
                    closeDropdown();
                }, 200);
            });

            cityInput.addEventListener('keydown', (e) => {
                if (!searchableDropdown.classList.contains('open')) {
                    if (e.key === 'ArrowDown' || e.key === 'Enter') {
                        e.preventDefault();
                        openDropdown();
                        return;
                    }
                }

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredCities.length - 1);
                        renderOptions();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        renderOptions();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0 && filteredCities[selectedIndex]) {
                            selectCity(filteredCities[selectedIndex]);
                        }
                        break;
                    case 'Escape':
                        closeDropdown();
                        break;
                }
            });

            // Click outside to close
            document.addEventListener('click', (e) => {
                if (!searchableDropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Prevent invalid input
            cityInput.addEventListener('keypress', (e) => {
                // Allow typing, but we'll validate on blur
            });

            cityInput.addEventListener('blur', () => {
                const value = cityInput.value;
                if (value && !cities.includes(value)) {
                    // Find closest match
                    const closest = cities.find(city => 
                        city.toLowerCase().startsWith(value.toLowerCase())
                    );
                    if (closest) {
                        cityInput.value = closest;
                        cityInput.setAttribute('data-value', closest);
                    } else {
                        // Clear invalid input
                        cityInput.value = '';
                        cityInput.removeAttribute('data-value');
                    }
                }
            });
        }

        // Load unique skills from internships API (one-time)
        async function loadSkillsSuggestions() {
            try {
                const res = await fetch(`${API_BASE}/internships`);
                if (!res.ok) throw new Error('Failed to load internships for skills');
                const json = await res.json();
                let internships = [];
                if (Array.isArray(json)) internships = json;
                else if (Array.isArray(json.internships)) internships = json.internships;
                else if (Array.isArray(json.data)) internships = json.data;
                const map = new Map(); // lower -> display
                // Curated popular technical skills to supplement dataset
                const curatedSkills = [
                    'Python', 'JavaScript', 'TypeScript', 'Java', 'C++', 'C#', 'Go', 'Rust',
                    'HTML', 'CSS', 'Tailwind CSS', 'Bootstrap', 'React', 'Next.js', 'Angular', 'Vue.js', 'Svelte',
                    'Node.js', 'Express.js', 'Django', 'Flask', 'Spring Boot', 'FastAPI',
                    'SQL', 'MySQL', 'PostgreSQL', 'SQLite', 'NoSQL', 'MongoDB', 'Redis',
                    'REST APIs', 'GraphQL', 'gRPC',
                    'Git', 'GitHub', 'Docker', 'Kubernetes', 'CI/CD', 'Jenkins', 'GitLab CI',
                    'AWS', 'Azure', 'GCP', 'Firebase', 'Cloud Functions',
                    'Linux', 'Bash', 'Powershell',
                    'Pandas', 'NumPy', 'Matplotlib', 'Seaborn', 'scikit-learn', 'TensorFlow', 'PyTorch', 'OpenCV', 'NLTK',
                    'Apache Spark', 'Hadoop', 'Kafka',
                    'Terraform', 'Ansible', 'Prometheus', 'Grafana',
                    'Selenium', 'Cypress', 'Playwright', 'Jest', 'Mocha', 'PyTest',
                    'Agile', 'Scrum', 'JIRA', 'Figma', 'UX/UI', 'Microservices', 'OOP', 'DSA'
                ];
                for (const s of curatedSkills) {
                    const disp = (s || '').trim();
                    if (!disp) continue;
                    const key = disp.toLowerCase();
                    if (!map.has(key)) map.set(key, disp);
                }
                for (const it of internships) {
                    const arr = Array.isArray(it.skills_required) ? it.skills_required : [];
                    for (const raw of arr) {
                        if (typeof raw !== 'string') continue;
                        const s = raw.trim();
                        if (!s) continue;
                        const key = s.toLowerCase();
                        if (!map.has(key)) map.set(key, s);
                    }
                }
                allSkillSuggestions = Array.from(map.values()).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
                allSkillSuggestionsLower = new Set(map.keys());
            } catch (e) {
                console.warn('Could not load skills suggestions:', e);
                allSkillSuggestions = [];
                allSkillSuggestionsLower = new Set();
            }
        }

        // Skills dropdown rendering and behavior
        function renderSkillOptions() {
            skillsDropdown.innerHTML = '';
            if (!filteredSkills.length) {
                skillsDropdown.innerHTML = '<div class="no-results">No skills found</div>';
                return;
            }
            filteredSkills.forEach((skill, index) => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.textContent = skill;
                option.dataset.value = skill;
                if (index === selectedSkillIndex) {
                    option.classList.add('highlighted');
                    option.scrollIntoView({ block: 'nearest' });
                }
                option.addEventListener('click', () => {
                    selectSkillSuggestion(skill);
                });
                skillsDropdown.appendChild(option);
            });
        }

        function openSkillsDropdown() {
            skillsDropdownWrapper.classList.add('open');
            renderSkillOptions();
        }

        function closeSkillsDropdown() {
            skillsDropdownWrapper.classList.remove('open');
            selectedSkillIndex = -1;
        }

        function filterSkillsList(query) {
            const q = (query || '').trim().toLowerCase();
            const existing = new Set(skills.map(s => s.toLowerCase()));
            if (!q) {
                filteredSkills = allSkillSuggestions.filter(s => !existing.has(s.toLowerCase()));
            } else {
                filteredSkills = allSkillSuggestions.filter(s => s.toLowerCase().includes(q) && !existing.has(s.toLowerCase()));
            }
            selectedSkillIndex = -1;
            renderSkillOptions();
        }

        function selectSkillSuggestion(displaySkill) {
            const val = (displaySkill || '').trim().toLowerCase();
            if (val && !skills.includes(val)) {
                skills.push(val);
                renderSkills();
            }
            // Clear input for next entry
            skillInput.value = '';
            filterSkillsList('');
            openSkillsDropdown();
        }

        // Check if user has existing profile
        async function checkExistingProfile() {
            const candidateId = localStorage.getItem('candidate_id');
            if (!candidateId) {
                // If not logged in or no candidate_id, show empty form
                profileDisplay.classList.add('hidden');
                profileFormSection.classList.remove('hidden');
                return;
            }
            try {
                // Fetch the current user's profile by candidate_id with cache-busting
                const cacheBuster = new Date().getTime();
                const response = await fetch(`${API_BASE}/profile/${candidateId}?t=${cacheBuster}`, {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                const result = await response.json();
                console.log('Profile fetch response:', result); // Debug log
                if (response.ok && result) {
                    // Handle different response formats
                    let profileData = null;
                    if (result.candidate_id) {
                        // Direct profile format
                        profileData = result;
                    } else if (result.profile) {
                        // Wrapped profile format
                        profileData = result.profile;
                    } else if (result.data && result.data.candidate_id) {
                        // Data wrapper format
                        profileData = result.data;
                    }
                    
                    if (profileData) {
                        currentProfile = profileData;
                        displayProfile(profileData);
                        profileDisplay.classList.remove('hidden');
                        profileFormSection.classList.add('hidden');
                        editToggleBtn.textContent = 'Edit Profile';
                        isEditMode = false;
                        return;
                    }
                }
            } catch (error) {
                console.log('No existing profile found:', error);
            }
            // If no profile found, show empty form
            profileDisplay.classList.add('hidden');
            profileFormSection.classList.remove('hidden');
        }

        // Display existing profile
        function displayProfile(profile) {
            profileInfo.innerHTML = `
                <div class="info-item">
                    <label>Name</label>
                    <div class="value">${escapeHtml(profile.name || 'Not specified')}</div>
                </div>
                <div class="info-item">
                    <label>Education Level</label>
                    <div class="value">${escapeHtml(profile.education_level || 'Not specified')}</div>
                </div>
                <div class="info-item">
                    <label>Field of Study</label>
                    <div class="value">${escapeHtml(profile.field_of_study || 'Not specified')}</div>
                </div>
                <div class="info-item">
                    <label>Location Preference</label>
                    <div class="value">${escapeHtml(profile.location_preference || 'Not specified')}</div>
                </div>
                <div class="info-item">
                    <label>Skills</label>
                    <div class="skills-display">
                        ${(profile.skills_possessed || []).map(skill => 
                            `<span class="skill-display">${escapeHtml(skill)}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="info-item">
                    <label>Sector Interests</label>
                    <div class="value">${escapeHtml((profile.sector_interests || []).join(', ') || 'Not specified')}</div>
                </div>
            `;
            
            profileDisplay.classList.remove('hidden');
            profileFormSection.classList.add('hidden');
        }

        // Toggle edit mode
        function toggleEdit() {
            if (isEditMode) {
                // Switch to display mode
                profileDisplay.classList.remove('hidden');
                profileFormSection.classList.add('hidden');
                editToggleBtn.textContent = 'Edit Profile';
                isEditMode = false;
            } else {
                // Switch to edit mode - fetch fresh data first
                const candidateId = localStorage.getItem('candidate_id');
                if (candidateId) {
                    // Fetch fresh profile data before editing
                    fetch(`${API_BASE}/profile/${candidateId}?t=${new Date().getTime()}`, {
                        credentials: 'include',
                        cache: 'no-cache'
                    })
                    .then(response => response.json())
                    .then(result => {
                        console.log('Fresh profile data for editing:', result);
                        // Handle different response formats
                        let profileData = null;
                        if (result.candidate_id) {
                            profileData = result;
                        } else if (result.profile) {
                            profileData = result.profile;
                        } else if (result.data && result.data.candidate_id) {
                            profileData = result.data;
                        }
                        
                        if (profileData) {
                            currentProfile = profileData;
                            populateForm(profileData);
                            profileDisplay.classList.add('hidden');
                            profileFormSection.classList.remove('hidden');
                            editToggleBtn.textContent = 'Cancel Edit';
                            isEditMode = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching fresh profile data:', error);
                        // Fallback to cached data
                        if (currentProfile) {
                            populateForm(currentProfile);
                        }
                        profileDisplay.classList.add('hidden');
                        profileFormSection.classList.remove('hidden');
                        editToggleBtn.textContent = 'Cancel Edit';
                        isEditMode = true;
                    });
                } else {
                    // No candidate_id, fallback to cached data
                    if (currentProfile) {
                        populateForm(currentProfile);
                    }
                    profileDisplay.classList.add('hidden');
                    profileFormSection.classList.remove('hidden');
                    editToggleBtn.textContent = 'Cancel Edit';
                    isEditMode = true;
                }
            }
        }

        // Populate form with existing data
        function populateForm(profile) {
            document.getElementById('name').value = profile.name || '';
            document.getElementById('education_level').value = profile.education_level || '';
            document.getElementById('field_of_study').value = profile.field_of_study || '';
            
            // Set city value and data attribute
            const cityValue = profile.location_preference || '';
            cityInput.value = cityValue;
            if (cityValue) {
                cityInput.setAttribute('data-value', cityValue);
            }
            
            document.getElementById('sector_interests').value = (profile.sector_interests || []).join(', ');
            
            skills = [...(profile.skills_possessed || [])];
            renderSkills();
        }

        // Add skill functionality
        addSkillBtn.addEventListener('click', addSkill);
        // Skills dropdown events
        skillInput.addEventListener('input', (e) => {
            filterSkillsList(e.target.value);
            openSkillsDropdown();
        });
        skillInput.addEventListener('focus', () => {
            filterSkillsList(skillInput.value);
            openSkillsDropdown();
        });
        skillInput.addEventListener('blur', () => {
            setTimeout(() => closeSkillsDropdown(), 200);
        });
        // Use keydown to handle arrows and enter
        skillInput.addEventListener('keydown', (e) => {
            if (!skillsDropdownWrapper.classList.contains('open')) {
                if (e.key === 'ArrowDown' || e.key === 'Enter') {
                    e.preventDefault();
                    openSkillsDropdown();
                    return;
                }
            }
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedSkillIndex = Math.min(selectedSkillIndex + 1, filteredSkills.length - 1);
                    renderSkillOptions();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedSkillIndex = Math.max(selectedSkillIndex - 1, -1);
                    renderSkillOptions();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedSkillIndex >= 0 && filteredSkills[selectedSkillIndex]) {
                        selectSkillSuggestion(filteredSkills[selectedSkillIndex]);
                    } else {
                        // Add whatever is typed
                        addSkill();
                    }
                    break;
                case 'Escape':
                    closeSkillsDropdown();
                    break;
            }
        });
        document.addEventListener('click', (e) => {
            if (!skillsDropdownWrapper.contains(e.target)) {
                closeSkillsDropdown();
            }
        });

        function addSkill() {
            const skill = skillInput.value.trim().toLowerCase();
            if (skill && !skills.includes(skill)) {
                skills.push(skill);
                skillInput.value = '';
                renderSkills();
                // Refresh suggestion list and close dropdown to avoid overlaying button
                filterSkillsList('');
                closeSkillsDropdown();
            }
        }

        function removeSkill(skillToRemove) {
            skills = skills.filter(skill => skill !== skillToRemove);
            renderSkills();
        }

        function renderSkills() {
            skillsContainer.innerHTML = skills.map(skill => `
                <div class="skill-tag">
                    ${skill}
                    <span class="remove" onclick="removeSkill('${skill}')">&times;</span>
                </div>
            `).join('');
        }

        // Form submission
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Disable submit button to prevent double submission
            const submitBtn = profileForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                if (skills.length === 0) {
                    showMessage('Please add at least one skill', 'error');
                    return;
                }

                const formData = new FormData(profileForm);
                const username = localStorage.getItem('username');
                console.log('Saving profile for username:', username); // Debug log
                
                // Validate required fields
                if (!formData.get('name')?.trim()) {
                    showMessage('Please enter your name', 'error');
                    return;
                }
                
                if (!formData.get('education_level')) {
                    showMessage('Please select your education level', 'error');
                    return;
                }
                
                if (!cityInput.getAttribute('data-value') && !cityInput.value.trim()) {
                    showMessage('Please select a valid city', 'error');
                    return;
                }

                const profileData = {
                    name: formData.get('name').trim(),
                    education_level: formData.get('education_level'),
                    field_of_study: formData.get('field_of_study')?.trim() || '',
                    location_preference: cityInput.getAttribute('data-value') || cityInput.value.trim(),
                    skills_possessed: skills,
                    sector_interests: formData.get('sector_interests') ? formData.get('sector_interests').split(',').map(s => s.trim()).filter(s => s) : []
                };

                // If editing existing profile, include the candidate_id
                if (currentProfile && currentProfile.candidate_id) {
                    profileData.candidate_id = currentProfile.candidate_id;
                }

                console.log('Profile data to save:', profileData); // Debug log
                showMessage('Saving profile...', 'success');
                
                // Add retry logic for backend refresh scenarios
                let response;
                let result;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(`${API_BASE}/profile`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(profileData)
                        });
                        
                        if (response.ok) {
                            result = await response.json();
                            break;
                        } else if (response.status === 503 || response.status === 502) {
                            // Backend is refreshing, wait and retry
                            retryCount++;
                            if (retryCount < maxRetries) {
                                showMessage(`Backend is refreshing, retrying... (${retryCount}/${maxRetries})`, 'success');
                                await new Promise(resolve => setTimeout(resolve, 2000 * retryCount)); // Exponential backoff
                                continue;
                            }
                        } else {
                            result = await response.json();
                            break;
                        }
                    } catch (fetchError) {
                        retryCount++;
                        if (retryCount < maxRetries) {
                            showMessage(`Connection issue, retrying... (${retryCount}/${maxRetries})`, 'success');
                            await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
                            continue;
                        } else {
                            throw fetchError;
                        }
                    }
                }

                if (response.ok) {
                    console.log('Profile save successful, result:', result); // Debug log
                    showMessage('Profile saved successfully! You can now view personalized recommendations on the main page.', 'success');

                    console.log('Profile save response:', result); // Debug log

                    // Handle different response formats for candidate_id
                    let candidateId = null;
                    if (result.candidate_id) {
                        candidateId = result.candidate_id;
                    } else if (result.data && result.data.candidate_id) {
                        candidateId = result.data.candidate_id;
                    } else if (result.candidate && result.candidate.candidate_id) {
                        candidateId = result.candidate.candidate_id;
                    }

                    // Store candidate_id for personalized recommendations
                    if (candidateId) {
                        localStorage.setItem('candidate_id', candidateId);
                        console.log('Stored candidate_id in localStorage:', candidateId);
                    }

                    // Clear any cached data to ensure fresh data on next load
                    localStorage.removeItem('lastDataLoad');

                    // Fetch the fresh profile from backend to avoid stale/minimal POST response
                    const submittedProfile = profileData; // keep the form submission as fallback
                    try {
                        const cacheBuster = Date.now();
                        const freshRes = await fetch(`${API_BASE}/profile/${candidateId}?t=${cacheBuster}`, {
                            credentials: 'include',
                            cache: 'no-cache'
                        });
                        if (freshRes.ok) {
                            const freshData = await freshRes.json();
                            let loadedProfile = null;
                            if (freshData.candidate_id) loadedProfile = freshData;
                            else if (freshData.profile) loadedProfile = freshData.profile;
                            else if (freshData.data && freshData.data.candidate_id) loadedProfile = freshData.data;
                            currentProfile = loadedProfile || { ...submittedProfile, candidate_id };
                        } else {
                            // Fallback: use submitted data if server GET fails
                            currentProfile = { ...submittedProfile, candidate_id };
                        }
                    } catch (e) {
                        console.warn('Failed to fetch fresh profile; using submitted data', e);
                        currentProfile = { ...submittedProfile, candidate_id };
                    }

                    // Switch to display mode with fresh profile
                    displayProfile(currentProfile);
                    profileDisplay.classList.remove('hidden');
                    profileFormSection.classList.add('hidden');
                    editToggleBtn.textContent = 'Edit Profile';
                    isEditMode = false;
                } else {
                    showMessage(result.error || 'Failed to save profile', 'error');
                }
            } catch (error) {
                console.error('Profile save error:', error);
                showMessage('Error saving profile: ' + error.message, 'error');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Recommendation functions removed - recommendations are now shown on the main index.html page

        function showMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        // Check login status
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                // Redirect to login page if not logged in
                window.location.href = 'login.html';
                return;
            }
        }

        // Pre-fill name with username
        function prefillName() {
            const username = localStorage.getItem('username');
            if (username) {
                const nameField = document.getElementById('name');
                if (nameField && !nameField.value) {
                    nameField.value = username;
                }
            }
        }

        // Initialize
        currentProfile = null; // Clear any cached profile data
        checkLoginStatus();
        prefillName();
        initializeCityDropdown();
        // Load skills suggestions asynchronously before checking existing profile
        loadSkillsSuggestions()
            .then(() => {
                filterSkillsList('');
            })
            .catch(() => {
                // Even if suggestions fail, proceed
            });
        checkExistingProfile();
    </script>
</body>
</html>